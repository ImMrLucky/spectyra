<div class="studio-page">
  <div *ngIf="loading" class="loading-state">
    <p>Loading Spectyra Studio...</p>
  </div>

  <div *ngIf="!loading && (!isAuthenticated || !isOwner)" class="access-denied">
    <h2>Spectyra Studio</h2>
    <div class="error-card">
      <p>{{ error || 'Access denied' }}</p>
      <a routerLink="/login" [queryParams]="{ returnUrl: '/admin/studio' }" class="login-link">Log in</a>
    </div>
  </div>

  <div *ngIf="!loading && isAuthenticated && isOwner" class="studio-content">
    <header class="studio-header">
      <h1>Spectyra Studio</h1>
      <p class="subtitle">Run Raw vs Spectyra side-by-side across common scenarios</p>
    </header>

    <div class="studio-layout">
      <!-- Left panel: setup -->
      <section class="setup-panel">
        <div class="panel-header">
          <h2>Setup</h2>
        </div>

        <div class="form-group">
          <label>Scenario</label>
          <select class="form-select" [(ngModel)]="scenarioId" (ngModelChange)="onScenarioChange()">
            <option *ngFor="let s of scenarios" [value]="s.id">{{ s.title }}</option>
          </select>
          <small class="hint">{{ selectedScenario.description }}</small>
        </div>

        <div class="form-group">
          <label>{{ selectedScenario.inputSchema.primaryLabel }}</label>
          <textarea
            class="form-textarea"
            rows="6"
            [(ngModel)]="primary"
            [placeholder]="selectedScenario.inputSchema.primaryPlaceholder"></textarea>
        </div>

        <div class="form-group" *ngIf="selectedScenario.inputSchema.secondaryLabel">
          <label>{{ selectedScenario.inputSchema.secondaryLabel }}</label>
          <textarea
            class="form-textarea"
            rows="4"
            [(ngModel)]="secondary"
            [placeholder]="selectedScenario.inputSchema.secondaryPlaceholder"></textarea>
        </div>

        <div class="form-group">
          <button class="btn-link" (click)="useExample()">Use Example</button>
          <button class="btn-link" (click)="showAdvanced = !showAdvanced">
            {{ showAdvanced ? 'Hide Advanced' : 'Advanced' }}
          </button>
        </div>

        <div class="advanced" *ngIf="showAdvanced">
          <div class="form-row">
            <label>Run mode</label>
            <select [(ngModel)]="runMode" (ngModelChange)="onRunModeChange()">
              <option value="scenario">Scenario (dry-run estimates)</option>
              <option value="live">Live (2 provider calls, actual tokens)</option>
            </select>
          </div>

          <div class="checkbox-row">
            <label>
              <input type="checkbox" [(ngModel)]="advanced.showMoreScenarios" (ngModelChange)="onShowMoreScenariosChange()" />
              More scenarios
            </label>
          </div>
          <div class="checkbox-row">
            <label><input type="checkbox" [(ngModel)]="advanced.showToolCalls" /> Show tool calls</label>
          </div>
          <div class="checkbox-row">
            <label><input type="checkbox" [(ngModel)]="advanced.showPolicyEvaluation" /> Show policy evaluation</label>
          </div>
          <div class="checkbox-row">
            <label><input type="checkbox" [(ngModel)]="advanced.showTokenBreakdown" /> Show token breakdown</label>
          </div>
          <div class="hint" *ngIf="runMode === 'scenario'">
            Scenario mode makes no provider calls. Tokens/cost are estimated.
          </div>

          <div class="hint" *ngIf="runMode === 'live'">
            Live mode makes <b>two</b> real provider calls (Raw + Spectyra) to measure actual tokens and latency (incurs ~2× cost). Requires a vaulted provider key or BYOK key.
          </div>

          <div class="form-row" *ngIf="runMode === 'live'">
            <label>Provider</label>
            <select [(ngModel)]="advanced.provider">
              <option value="anthropic">Anthropic (Claude)</option>
              <option value="openai">OpenAI</option>
            </select>
          </div>

          <div class="form-row" *ngIf="runMode === 'live'">
            <label>BYOK provider key (optional)</label>
            <input type="password" [(ngModel)]="advanced.byokProviderKey" placeholder="Sent as X-PROVIDER-KEY (not stored)" />
          </div>

          <div class="form-row" *ngIf="runMode === 'live'">
            <label>Model</label>
            <input type="text" [(ngModel)]="advanced.model" placeholder="claude-3-5-sonnet-latest" />
          </div>

          <div class="form-row" *ngIf="runMode === 'live'">
            <label>Optimization level (0-4)</label>
            <input type="number" min="0" max="4" [(ngModel)]="advanced.optimizationLevel" />
          </div>
        </div>

        <button class="run-button" (click)="runRawVsSpectyra()" [disabled]="running">
          <mat-icon class="btn-icon">play_arrow</mat-icon>
          {{ running ? 'Running...' : 'Run Raw vs Spectyra' }}
        </button>
      </section>

      <!-- Right panel: results -->
      <section class="results-panel">
        <div class="panel-header">
          <h2>Results</h2>
        </div>

        <div *ngIf="!result" class="empty-results">
          <p>Pick a scenario, click <b>Use Example</b>, then run.</p>
        </div>

        <div *ngIf="result" class="results">
          <!-- Optimizer Lab-style tabs -->
          <div class="results-tabs" role="tablist">
            <button type="button" role="tab" class="tab-button" [class.active]="activeTab === 'metrics'" (click)="switchTab('metrics')">
              <mat-icon class="tab-icon">insights</mat-icon>
              Metrics
            </button>
            <button type="button" role="tab" class="tab-button" [class.active]="activeTab === 'before'" (click)="switchTab('before')">
              <mat-icon class="tab-icon">radio_button_unchecked</mat-icon>
              Before
            </button>
            <button type="button" role="tab" class="tab-button" [class.active]="activeTab === 'after'" (click)="switchTab('after')">
              <mat-icon class="tab-icon">check_circle_outline</mat-icon>
              After
            </button>
            <button type="button" role="tab" class="tab-button" [class.active]="activeTab === 'diff'" (click)="switchTab('diff')">
              <mat-icon class="tab-icon">compare_arrows</mat-icon>
              Diff
            </button>
          </div>

          <div class="tab-content active" role="tabpanel">
            <!-- Metrics -->
            <div *ngIf="activeTab === 'metrics'" class="tab-pane metrics-pane">
              <div class="savings-hero" [class.no-savings]="!hasSavings">
                <div class="savings-value">{{ savingsHeroValue }}</div>
                <div class="savings-label">{{ savingsHeroLabel }}</div>
                <div class="metric-sub" style="margin-top:6px;">
                  Tokens before/after: {{ tokensBeforeAfterLabel }}
                </div>
              </div>

              <div style="margin: 10px 0 2px 0;">
                <button class="btn-sm" (click)="copyRunAsFixture()">
                  <mat-icon class="btn-icon-sm">content_copy</mat-icon>
                  Copy run as fixture (for scenario calibration)
                </button>
              </div>

              <div class="metrics-grid">
                <div class="metric-card">
                  <div class="metric-label">Input Tokens Before</div>
                  <div class="metric-value">{{ result.raw.tokens.input }}</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Input Tokens After</div>
                  <div class="metric-value success">{{ result.spectyra.tokens.input }}</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">{{ hasSavings ? 'Tokens Saved' : 'Tokens Added' }}</div>
                  <div class="metric-value">{{ hasSavings ? tokensSaved : tokensAdded }}</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Est. Cost Change</div>
                  <div class="metric-value">{{ (result.metrics.costSavingsPct ?? 0) | number:'1.0-2' }}%</div>
                  <div class="metric-sub" *ngIf="result.meta?.estimated">Estimated</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Latency</div>
                  <div class="metric-value" *ngIf="result.raw.modelOutputText">{{ result.raw.latencyMs }}ms → {{ result.spectyra.latencyMs }}ms</div>
                  <div class="metric-value" *ngIf="!result.raw.modelOutputText">{{ result.spectyra.latencyMs }}ms</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Mode</div>
                  <div class="metric-value">{{ result.meta?.estimated ? 'DRY-RUN' : 'LIVE' }}</div>
                  <div class="metric-sub" *ngIf="result.meta?.estimated">Token/cost are estimated</div>
                  <div class="metric-sub" *ngIf="result.meta?.reverted">Reverted</div>
                </div>
              </div>

              <div class="transforms-section">
                <div class="transforms-title">Applied Transforms</div>
                <div class="transforms-list">
                  <span *ngFor="let t of (result.appliedTransforms ?? [])" class="transform-badge">{{ t }}</span>
                  <span *ngIf="!(result.appliedTransforms?.length)" class="no-transforms">No transforms applied</span>
                </div>
              </div>

              <div class="why-savings-section" *ngIf="result.metrics.violationsPrevented != null || (showAdvanced && advanced.showTokenBreakdown)">
                <div class="why-title">Governance & tool signals</div>
                <ul class="why-savings-list">
                  <li *ngIf="result.metrics.violationsPrevented != null"><strong>Violations prevented:</strong> {{ result.metrics.violationsPrevented }}</li>
                  <li *ngIf="result.raw.toolSignals && result.spectyra.toolSignals">
                    <strong>Tool signals (run/read/patch):</strong>
                    {{ result.raw.toolSignals.run_terminal_cmd }}/{{ result.raw.toolSignals.read_file }}/{{ result.raw.toolSignals.apply_patch }}
                    →
                    {{ result.spectyra.toolSignals.run_terminal_cmd }}/{{ result.spectyra.toolSignals.read_file }}/{{ result.spectyra.toolSignals.apply_patch }}
                  </li>
                </ul>
              </div>
            </div>

            <!-- Before -->
            <div *ngIf="activeTab === 'before'" class="tab-pane content-pane">
              <div class="content-header">
                <h3>Original Prompt (Before)</h3>
                <button class="btn-sm" (click)="copyToClipboard(result.raw.promptText)">
                  <mat-icon class="btn-icon-sm">content_copy</mat-icon>
                  Copy
                </button>
              </div>
              <pre class="prompt-body">{{ result.raw.promptText }}</pre>
              <div class="details" *ngIf="showAdvanced && advanced.showPolicyEvaluation">
                <div class="details-title">Policy evaluation</div>
                <div class="details-empty" *ngIf="!result.raw.violations || result.raw.violations.length === 0">No violations detected.</div>
                <ul class="violations" *ngIf="result.raw.violations && result.raw.violations.length > 0">
                  <li *ngFor="let v of result.raw.violations">
                    <span class="code">{{ v.code }}</span>
                    <span class="msg">{{ v.message }}</span>
                  </li>
                </ul>
              </div>
            </div>

            <!-- After -->
            <div *ngIf="activeTab === 'after'" class="tab-pane content-pane">
              <div class="content-header">
                <h3>Optimized Prompt (After)</h3>
                <button class="btn-sm" (click)="copyToClipboard(result.spectyra.promptText)">
                  <mat-icon class="btn-icon-sm">content_copy</mat-icon>
                  Copy
                </button>
              </div>
              <pre class="prompt-body">{{ result.spectyra.promptText }}</pre>
              <div class="details" *ngIf="showAdvanced && advanced.showPolicyEvaluation">
                <div class="details-title">Policy evaluation</div>
                <div class="details-empty" *ngIf="!result.spectyra.violations || result.spectyra.violations.length === 0">No violations detected.</div>
                <ul class="violations" *ngIf="result.spectyra.violations && result.spectyra.violations.length > 0">
                  <li *ngFor="let v of result.spectyra.violations">
                    <span class="code">{{ v.code }}</span>
                    <span class="msg">{{ v.message }}</span>
                  </li>
                </ul>
              </div>
            </div>

            <!-- Diff -->
            <div *ngIf="activeTab === 'diff'" class="tab-pane diff-pane">
              <div class="content-header">
                <h3>Diff Summary</h3>
              </div>
              <div class="diff-summary">
                <div class="diff-row">
                  <span class="diff-label">Input tokens:</span>
                  <span class="diff-value">{{ result.raw.tokens.input }} → {{ result.spectyra.tokens.input }}</span>
                </div>
                <div class="diff-row">
                  <span class="diff-label">Saved:</span>
                  <span class="diff-value">{{ result.metrics.inputTokensSaved ?? 0 }} ({{ result.metrics.tokenSavingsPct ?? 0 | number:'1.0-2' }}%)</span>
                </div>
                <div class="diff-row" *ngIf="result.meta?.reverted">
                  <span class="diff-label">Note:</span>
                  <span class="diff-value">Optimized prompt exceeded baseline, so the pipeline reverted.</span>
                </div>
              </div>
            </div>
          </div>

          <div class="history" *ngIf="runHistory.length > 1">
            <h3>Run history</h3>
            <div class="history-list">
              <button
                class="history-item"
                *ngFor="let r of runHistory"
                (click)="restoreFromHistory(r)">
                <span class="id">{{ r.runId.slice(0, 8) }}</span>
                <span class="time">{{ r.createdAt }}</span>
                <span class="meta">{{ r.metrics.tokenSavingsPct ?? 0 | number:'1.0-1' }}% input saved</span>
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>


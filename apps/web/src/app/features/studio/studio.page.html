<div class="studio-page">
  <div *ngIf="loading" class="loading-state">
    <p>Loading Spectyra Studio...</p>
  </div>

  <div *ngIf="!loading && (!isAuthenticated || !isOwner)" class="access-denied">
    <h2>Spectyra Studio</h2>
    <div class="error-card">
      <p>{{ error || 'Access denied' }}</p>
      <a routerLink="/login" [queryParams]="{ returnUrl: '/admin/studio' }" class="login-link">Log in</a>
    </div>
  </div>

  <div *ngIf="!loading && isAuthenticated && isOwner" class="studio-content">
    <header class="studio-header">
      <h1>Spectyra Studio</h1>
      <p class="subtitle">Run Raw vs Spectyra side-by-side across common scenarios</p>
    </header>

    <div class="studio-layout">
      <!-- Left panel: setup -->
      <section class="setup-panel">
        <div class="panel-header">
          <h2>Setup</h2>
        </div>

        <div class="form-group">
          <label>Scenario</label>
          <select class="form-select" [(ngModel)]="scenarioId" (ngModelChange)="onScenarioChange()">
            <option *ngFor="let s of scenarios" [value]="s.id">{{ s.title }}</option>
          </select>
          <small class="hint">{{ selectedScenario.description }}</small>
        </div>

        <div class="form-group">
          <label>{{ selectedScenario.inputSchema.primaryLabel }}</label>
          <textarea
            class="form-textarea"
            rows="6"
            [(ngModel)]="primary"
            [placeholder]="selectedScenario.inputSchema.primaryPlaceholder"></textarea>
        </div>

        <div class="form-group" *ngIf="selectedScenario.inputSchema.secondaryLabel">
          <label>{{ selectedScenario.inputSchema.secondaryLabel }}</label>
          <textarea
            class="form-textarea"
            rows="4"
            [(ngModel)]="secondary"
            [placeholder]="selectedScenario.inputSchema.secondaryPlaceholder"></textarea>
        </div>

        <div class="form-group">
          <button class="btn-link" (click)="useExample()">Use Example</button>
          <button class="btn-link" (click)="showAdvanced = !showAdvanced">
            {{ showAdvanced ? 'Hide Advanced' : 'Advanced' }}
          </button>
        </div>

        <div class="advanced" *ngIf="showAdvanced">
          <div class="checkbox-row">
            <label>
              <input type="checkbox" [(ngModel)]="advanced.showMoreScenarios" (ngModelChange)="onShowMoreScenariosChange()" />
              More scenarios
            </label>
          </div>
          <div class="checkbox-row">
            <label><input type="checkbox" [(ngModel)]="advanced.showToolCalls" /> Show tool calls</label>
          </div>
          <div class="checkbox-row">
            <label><input type="checkbox" [(ngModel)]="advanced.showPolicyEvaluation" /> Show policy evaluation</label>
          </div>
          <div class="checkbox-row">
            <label><input type="checkbox" [(ngModel)]="advanced.showTokenBreakdown" /> Show token breakdown</label>
          </div>
          <div class="checkbox-row">
            <label>
              <input type="checkbox" [(ngModel)]="advanced.liveProviderRun" />
              Use real provider tokens (live run)
            </label>
          </div>

          <div class="hint" *ngIf="advanced.liveProviderRun">
            This will make real provider calls (incurs cost). Requires a vaulted provider key or BYOK header.
          </div>

          <div class="form-row" *ngIf="advanced.liveProviderRun">
            <label>Provider</label>
            <select [(ngModel)]="advanced.provider">
              <option value="anthropic">Anthropic (Claude)</option>
              <option value="openai">OpenAI</option>
            </select>
          </div>

          <div class="form-row" *ngIf="advanced.liveProviderRun">
            <label>Model</label>
            <input type="text" [(ngModel)]="advanced.model" placeholder="claude-3-5-sonnet-latest" />
          </div>

          <div class="form-row" *ngIf="advanced.liveProviderRun">
            <label>Optimization level (0-4)</label>
            <input type="number" min="0" max="4" [(ngModel)]="advanced.optimizationLevel" />
          </div>
        </div>

        <button class="run-button" (click)="runRawVsSpectyra()" [disabled]="running">
          <mat-icon class="btn-icon">play_arrow</mat-icon>
          {{ running ? 'Running...' : 'Run Raw vs Spectyra' }}
        </button>
      </section>

      <!-- Right panel: results -->
      <section class="results-panel">
        <div class="panel-header">
          <h2>Results</h2>
        </div>

        <div *ngIf="!result" class="empty-results">
          <p>Pick a scenario, click <b>Use Example</b>, then run.</p>
        </div>

        <div *ngIf="result" class="results">
          <div class="metrics-row">
            <div class="metric-card">
              <div class="label">Raw prompt input tokens</div>
              <div class="value">{{ result.raw.tokens.input }}</div>
              <div class="sub">Total {{ result.raw.tokens.total }} • Output {{ result.raw.tokens.output }}</div>
            </div>
            <div class="metric-card">
              <div class="label">Spectyra prompt input tokens</div>
              <div class="value">{{ result.spectyra.tokens.input }}</div>
              <div class="sub">Total {{ result.spectyra.tokens.total }} • Output {{ result.spectyra.tokens.output }}</div>
            </div>
            <div class="metric-card">
              <div class="label">Input savings</div>
              <div class="value">{{ result.metrics.tokenSavingsPct ?? 0 | number:'1.0-2' }}%</div>
              <div class="sub">
                {{ result.metrics.inputTokensSaved ?? 0 }} tokens • Total saved {{ result.metrics.totalTokensSaved ?? 0 }}
              </div>
            </div>
            <div class="metric-card">
              <div class="label">Latency</div>
              <div class="value" *ngIf="result.raw.modelOutputText">{{ result.raw.latencyMs }}ms → {{ result.spectyra.latencyMs }}ms</div>
              <div class="value" *ngIf="!result.raw.modelOutputText">{{ result.spectyra.latencyMs }}ms</div>
              <div class="sub" *ngIf="result.raw.modelOutputText">Model latency (raw vs optimized)</div>
              <div class="sub" *ngIf="!result.raw.modelOutputText">Optimization latency</div>
            </div>
            <div class="metric-card" *ngIf="result.metrics.violationsPrevented != null">
              <div class="label">Violations prevented</div>
              <div class="value">{{ result.metrics.violationsPrevented }}</div>
              <div class="sub">Prompt-level governance checks</div>
            </div>
          </div>

          <div class="compare-grid">
            <div class="pane">
              <div class="pane-header">Raw prompt (before)</div>
              <pre class="pane-body">{{ result.raw.promptText }}</pre>
              <div class="details" *ngIf="showAdvanced && advanced.showPolicyEvaluation">
                <div class="details-title">Policy evaluation</div>
                <div class="details-empty" *ngIf="!result.raw.violations || result.raw.violations.length === 0">No violations detected.</div>
                <ul class="violations" *ngIf="result.raw.violations && result.raw.violations.length > 0">
                  <li *ngFor="let v of result.raw.violations">
                    <span class="code">{{ v.code }}</span>
                    <span class="msg">{{ v.message }}</span>
                  </li>
                </ul>
              </div>
              <div class="details" *ngIf="showAdvanced && result.raw.toolSignals">
                <div class="details-title">Tool signals</div>
                <div class="details-empty">
                  run_terminal_cmd: {{ result.raw.toolSignals.run_terminal_cmd }} • read_file: {{ result.raw.toolSignals.read_file }} • apply_patch: {{ result.raw.toolSignals.apply_patch }}
                </div>
              </div>
              <div class="details" *ngIf="showAdvanced && result.raw.modelOutputText">
                <div class="details-title">Model output (raw)</div>
                <pre class="pane-body">{{ result.raw.modelOutputText }}</pre>
              </div>
            </div>
            <div class="pane">
              <div class="pane-header">Spectyra prompt (after)</div>
              <pre class="pane-body">{{ result.spectyra.promptText }}</pre>
              <div class="details" *ngIf="showAdvanced && advanced.showPolicyEvaluation">
                <div class="details-title">Policy evaluation</div>
                <div class="details-empty" *ngIf="!result.spectyra.violations || result.spectyra.violations.length === 0">No violations detected.</div>
                <ul class="violations" *ngIf="result.spectyra.violations && result.spectyra.violations.length > 0">
                  <li *ngFor="let v of result.spectyra.violations">
                    <span class="code">{{ v.code }}</span>
                    <span class="msg">{{ v.message }}</span>
                  </li>
                </ul>
              </div>
              <div class="details" *ngIf="showAdvanced && result.spectyra.toolSignals">
                <div class="details-title">Tool signals</div>
                <div class="details-empty">
                  run_terminal_cmd: {{ result.spectyra.toolSignals.run_terminal_cmd }} • read_file: {{ result.spectyra.toolSignals.read_file }} • apply_patch: {{ result.spectyra.toolSignals.apply_patch }}
                </div>
              </div>
              <div class="details" *ngIf="showAdvanced && result.spectyra.modelOutputText">
                <div class="details-title">Model output (optimized)</div>
                <pre class="pane-body">{{ result.spectyra.modelOutputText }}</pre>
              </div>
            </div>
          </div>

          <div class="history" *ngIf="runHistory.length > 1">
            <h3>Run history</h3>
            <div class="history-list">
              <button
                class="history-item"
                *ngFor="let r of runHistory"
                (click)="restoreFromHistory(r)">
                <span class="id">{{ r.runId.slice(0, 8) }}</span>
                <span class="time">{{ r.createdAt }}</span>
                <span class="meta">{{ r.metrics.tokenSavingsPct ?? 0 | number:'1.0-1' }}% input saved</span>
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

